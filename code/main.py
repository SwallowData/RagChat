# !/user/bin/env python3
# -*- coding: utf-8 -*-
import streamlit as st
from chat_return import generate_response,get_chat_qa_chain,get_qa_chain

if __name__ == '__main__':
    st.title('ğŸ¦œğŸ”— åŠ¨æ‰‹å­¦å¤§æ¨¡å‹åº”ç”¨å¼€å‘')
    openai_api_key = st.sidebar.text_input('OpenAI API Key', type='password')
    openai_api_base = st.sidebar.text_input('OpenAI API Base', type='password')
    if not (openai_api_base and openai_api_base):
        st.info("Please add your OpenAI API key to continue.")
        st.stop()
    uploaded_files = st.sidebar.file_uploader(
        label="Upload PDF files", type=["pdf"], accept_multiple_files=True
    )
    if not uploaded_files:
        st.info("Please upload PDF documents to continue.")
        st.stop()

    # æ·»åŠ ä¸€ä¸ªé€‰æ‹©æŒ‰é’®æ¥é€‰æ‹©ä¸åŒçš„æ¨¡å‹
    # selected_method = st.sidebar.selectbox("é€‰æ‹©æ¨¡å¼", ["qa_chain", "chat_qa_chain", "None"])
    selected_method = st.radio(
        "ä½ æƒ³é€‰æ‹©å“ªç§æ¨¡å¼è¿›è¡Œå¯¹è¯ï¼Ÿ",
        ["None", "qa_chain", "chat_qa_chain"],
        captions=["ä¸ä½¿ç”¨æ£€ç´¢é—®ç­”çš„æ™®é€šæ¨¡å¼", "ä¸å¸¦å†å²è®°å½•çš„æ£€ç´¢é—®ç­”æ¨¡å¼", "å¸¦å†å²è®°å½•çš„æ£€ç´¢é—®ç­”æ¨¡å¼"])

    # ç”¨äºè·Ÿè¸ªå¯¹è¯å†å²
    if 'messages' not in st.session_state:
        st.session_state.messages = []

    messages = st.container(height=500)
    if prompt := st.chat_input("Say something"):
        # å°†ç”¨æˆ·è¾“å…¥æ·»åŠ åˆ°å¯¹è¯å†å²ä¸­
        st.session_state.messages.append({"role": "user", "text": prompt})

        if selected_method == "None":
            # è°ƒç”¨ respond å‡½æ•°è·å–å›ç­”
            answer = generate_response(prompt, openai_api_key, openai_api_base)
        elif selected_method == "qa_chain":
            answer = get_qa_chain(prompt, openai_api_key, openai_api_base,uploaded_files)
        elif selected_method == "chat_qa_chain":
            answer = get_chat_qa_chain(question=prompt, openai_api_key=openai_api_key, openai_api_base=openai_api_base,
                                       uploaded_files=uploaded_files)

        # æ£€æŸ¥å›ç­”æ˜¯å¦ä¸º None
        if answer is not None:
            # å°†LLMçš„å›ç­”æ·»åŠ åˆ°å¯¹è¯å†å²ä¸­
            st.session_state.messages.append({"role": "assistant", "text": answer})

        # æ˜¾ç¤ºæ•´ä¸ªå¯¹è¯å†å²
        for message in st.session_state.messages:
            if message["role"] == "user":
                messages.chat_message("user").write(message["text"])
            elif message["role"] == "assistant":
                messages.chat_message("assistant").write(message["text"])